<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Completo di Giapponese</title>
    <style>
        /* --- Stile Generale --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; background-color: #f0f2f5;
            color: #333; margin: 0; padding: 20px;
            box-sizing: border-box; min-height: 100vh;
        }
        h1, h2, h3 { color: #2c3e50; text-align: center; }
        .container { width: 100%; max-width: 450px; margin-bottom: 30px; }
        
        .card-ui {
            background-color: #ffffff; padding: 25px;
            border-radius: 16px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        }
        .card-ui-small {
            background-color: #fff; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        /* --- Menu Selezione Modalit√† --- */
        #mode-switcher {
            display: flex; gap: 15px; width: 100%;
            max-width: 450px; margin-bottom: 20px;
        }
        #mode-switcher button {
            flex: 1; padding: 15px; font-size: 1rem; font-weight: bold;
            border: 2px solid #007aff; border-radius: 10px;
            cursor: pointer; transition: all 0.2s;
        }
        #mode-switcher button.attivo { background-color: #007aff; color: white; }
        #mode-switcher button:not(.attivo) { background-color: #fff; color: #007aff; }

        /* --- Contenitori Nascosti --- */
        #vocab-wrapper, #kana-wrapper {
            display: none; /* Nascosti di default */
        }
        
        /* --- Stili Quiz Vocaboli --- */
        #punteggio-container { text-align: center; font-weight: 600; color: #555; font-size: 0.90rem; line-height: 1.5; }
        #punteggio-container span { margin: 0 5px; }
        .punteggio-corr { color: #2ca049; }
        .punteggio-sbag { color: #d92c23; }
        .punteggio-prio { color: #007aff; font-weight: bold; }
        .punteggio-mazzo { color: #5856d6; }
        .punteggio-sessione { color: #ff9500; font-weight: bold; }
        #quiz-container { margin-top: 20px; }
        #prompt-container { text-align: center; margin-bottom: 20px; min-height: 100px; display: flex; flex-direction: column; justify-content: center; }
        #prompt-label { font-size: 0.9rem; color: #777; margin-bottom: 10px; font-weight: bold; }
        #prompt-principale { font-size: 2.2rem; color: #333; margin: 0; }
        #prompt-secondario { font-size: 1.5rem; color: #555; margin-top: 5px; font-style: italic; }
        #input-risposta {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px;
            box-sizing: border-box; font-size: 1.2rem; text-align: center; margin-bottom: 15px;
        }
        #risultato-controllo { min-height: 50px; font-size: 1.1rem; font-weight: bold; text-align: center; padding: 5px; }
        .corretto { color: #2ca049; }
        .sbagliato { color: #d92c23; }
        .controlli { display: flex; gap: 15px; }
        .controlli button, .btn {
            flex-grow: 1; padding: 12px 20px; font-size: 1rem; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;
            color: white; width: 100%; box-sizing: border-box;
        }
        #pulsante-controlla { background-color: #007aff; }
        #pulsante-prossima { background-color: #34c759; }
        #pulsante-elimina { background-color: #ff3b30; margin-top: 15px; padding: 10px; font-size: 0.9rem; }
        #salva-sessione-container { text-align: center; margin-top: 20px; display: grid; gap: 10px; }
        #ripassa-errori-btn { background-color: #ff9500; }
        #ripassa-errori-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        #salva-sessione { background-color: #5856d6; }
        #salva-messaggio { font-size: 0.9rem; color: #333; height: 20px; font-weight: bold; }
        .sezione-gestione { border-top: 1px solid #eee; margin-top: 20px; padding-top: 20px; }
        #form-aggiungi div { margin-bottom: 15px; }
        #form-aggiungi label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        #form-aggiungi input, .input-text {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;
            box-sizing: border-box; font-size: 1rem;
        }
        #form-aggiungi button { background-color: #5856d6; }
        .messaggio-feedback { text-align: center; font-weight: bold; height: 20px; margin-top: 10px; }
        .label-sezione { display: block; margin-bottom: 10px; font-weight: 600; color: #555; text-align: center; }
        #import-csv-file { display: block; width: 100%; margin-top: 10px; }
        #import-dettagli { display: none; margin-top: 15px; }
        #import-dettagli h3 { font-size: 1rem; margin-top: 0; margin-bottom: 10px; color: #d92c23; text-align: center; }
        #import-errori-lista {
            font-size: 0.85rem; max-height: 150px; overflow-y: auto; background: #fdf6f6;
            border: 1px solid #f5c6cb; padding: 10px; margin: 0;
            border-radius: 6px; list-style-type: none;
        }
        #import-errori-lista li { margin-bottom: 5px; }
        #nessuna-carta { text-align: center; color: #777; padding: 20px; }
        .btn-audio { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0 5px; vertical-align: middle; }
        #prompt-principale .btn-audio { font-size: 1.8rem; position: relative; top: -2px; }
        .btn-audio:hover { opacity: 0.7; }
        #update-url-btn { background-color: #34c759; margin-top: 10px; }
        
        /* --- Stili Quiz Kana --- */
        #kana-quiz-container { text-align: center; }
        #punteggio-kana-container { margin-bottom: 20px; font-weight: bold; font-size: 1.1rem; }
        #prompt-kana { font-size: 8rem; color: #333; margin: 10px 0; line-height: 1; min-height: 130px; }
        #input-kana-risposta {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px;
            box-sizing: border-box; font-size: 1.2rem; text-align: center;
            margin-bottom: 15px; text-transform: lowercase;
        }
        #risultato-kana-controllo { min-height: 40px; font-size: 1.1rem; font-weight: bold; padding: 5px; }
        #pulsante-kana-controlla { background-color: #007aff; }
        #pulsante-kana-prossima { background-color: #34c759; }
        #ripassa-errori-kana-btn { background-color: #ff9500; margin-top: 10px; }
        #ripassa-errori-kana-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
    </style>
</head>
<body>

    <h1>Studio di Giapponese</h1>

    <div id="mode-switcher">
        <button id="btn-mode-vocab" class="attivo">Studia Vocaboli</button>
        <button id="btn-mode-kana">Studia Alfabeto</button>
    </div>

    <div id="vocab-wrapper">
        <div class="container card-ui-small" id="punteggio-container"></div>
        <div class="container card-ui" id="quiz-container">
            <div id="prompt-container">
                <div id="prompt-label"></div> 
                <h2 id="prompt-principale"></h2>
                <h3 id="prompt-secondario"></h3>
            </div>
            <input type="text" id="input-risposta" placeholder="...">
            <div id="risultato-controllo"></div>
            <div class="controlli">
                <button id="pulsante-controlla" class="btn">Controlla</button>
                <button id="pulsante-prossima" class="btn">Prossima</button>
            </div>
            <button id="pulsante-elimina" class="btn">Elimina Carta dal Mazzo Principale</button>
            <div id="nessuna-carta" style="display: none;"><p>Non ci sono carte! Aggiungine qualcuna.</p></div>
            <div id="salva-sessione-container">
                <button id="ripassa-errori-btn" class="btn" disabled>Ripassa Errori Sessione (0)</button>
                <button id="salva-sessione" class="btn">Salva Errori e Inizia Nuova Sessione</button>
                <p id="salva-messaggio"></p>
            </div>
        </div>
        <div class="container card-ui" id="form-container">
            <h2>Aggiornamento Online</h2>
            <div>
                <label for="csv-url-input" class="label-sezione">Link al tuo file .csv su GitHub:</label>
                <input type="text" id="csv-url-input" class="input-text" placeholder="https://raw.githubusercontent.com/tuo-nome/...">
                <button id="update-url-btn" class="btn">Aggiorna da Link</button>
                <p id="messaggio-update" class="messaggio-feedback"></p>
            </div>
            <div id="import-container" class="sezione-gestione">
                <label id="import-label" for="import-csv-file" class="label-sezione">Oppure... Importa da file locale</label>
                <input type="file" id="import-csv-file" accept=".csv">
                <p id="messaggio-import" class="messaggio-feedback"></p>
                <div id="import-dettagli">
                    <h3>Parole Saltate:</h3>
                    <ul id="import-errori-lista"></ul>
                </div>
            </div>
            <div class="sezione-gestione">
                <h2>Aggiungi una Parola Manualmente</h2>
                <form id="form-aggiungi">
                    <div><label for="input-ita">Italiano:</label><input type="text" id="input-ita" required></div>
                    <div><label for="input-eng">Inglese:</label><input type="text" id="input-eng" required></div>
                    <div><label for="input-jpn">Giapponese (Kanji/Hiragana):</label><input type="text" id="input-jpn" required></div>
                    <div><label for="input-romaji">Romaji (Pronuncia):</label><input type="text" id="input-romaji" required></div>
                    <button type="submit" class="btn">Salva Parola Manualmente</button>
                </form>
                <p id="messaggio-salvataggio" class="messaggio-feedback"></p>
            </div>
        </div>
    </div>

    <div id="kana-wrapper">
        <div class="container card-ui" id="kana-quiz-container">
            <h2>Quiz Alfabeto</h2>
            <div id="punteggio-kana-container"></div>
            <div id="prompt-kana"></div>
            <input type="text" id="input-kana-risposta" placeholder="Scrivi il Romaji...">
            <div id="risultato-kana-controllo"></div>
            <div class="controlli">
                <button id="pulsante-kana-controlla" class="btn">Controlla</button>
                <button id="pulsante-kana-prossima" class="btn">Prossima</button>
            </div>
            <button id="ripassa-errori-kana-btn" class="btn" disabled>Ripassa Errori Set (0)</button>
        </div>
    </div>


    <script>
        // --- 1. Elementi DOM (Globali) ---
        const synth = window.speechSynthesis;
        let japaneseVoice = null;

        // --- Elementi DOM Switcher ---
        const btnModeVocab = document.getElementById('btn-mode-vocab');
        const btnModeKana = document.getElementById('btn-mode-kana');
        const vocabWrapper = document.getElementById('vocab-wrapper');
        const kanaWrapper = document.getElementById('kana-wrapper'); // Modificato

        // --- Elementi DOM Vocab ---
        const promptContainer = document.getElementById('prompt-container');
        const promptLabel = document.getElementById('prompt-label');
        const promptPrincipale = document.getElementById('prompt-principale');
        const promptSecondario = document.getElementById('prompt-secondario');
        const inputRisposta = document.getElementById('input-risposta');
        const risultatoControllo = document.getElementById('risultato-controllo');
        const punteggioDisplay = document.getElementById('punteggio-container');
        const btnControlla = document.getElementById('pulsante-controlla');
        const btnProssima = document.getElementById('pulsante-prossima');
        const btnElimina = document.getElementById('pulsante-elimina');
        const salvaMessaggio = document.getElementById('salva-messaggio');
        const nessunaCartaMsg = document.getElementById('nessuna-carta');
        const quizContainer = document.getElementById('quiz-container');
        const btnSalvaSessione = document.getElementById('salva-sessione');
        const btnRipassaErrori = document.getElementById('ripassa-errori-btn');
        const form = document.getElementById('form-aggiungi');
        const inputIta = document.getElementById('input-ita');
        const inputEng = document.getElementById('input-eng');
        const inputJpn = document.getElementById('input-jpn');
        const inputRomaji = document.getElementById('input-romaji');
        const messaggioSalvataggio = document.getElementById('messaggio-salvataggio');
        const fileInput = document.getElementById('import-csv-file');
        const importMessaggio = document.getElementById('messaggio-import');
        const importDettagli = document.getElementById('import-dettagli');
        const importErroriLista = document.getElementById('import-errori-lista');
        const urlInput = document.getElementById('csv-url-input');
        const updateUrlBtn = document.getElementById('update-url-btn');
        const updateMessaggio = document.getElementById('messaggio-update');
        
        // --- Elementi DOM Kana (con nomi diversi) ---
        const punteggioKanaContainer = document.getElementById('punteggio-kana-container'); // Nuovo
        const promptKana = document.getElementById('prompt-kana');
        const inputKanaRisposta = document.getElementById('input-kana-risposta');
        const risultatoKanaControllo = document.getElementById('risultato-kana-controllo');
        const btnKanaControlla = document.getElementById('pulsante-kana-controlla');
        const btnKanaProssima = document.getElementById('pulsante-kana-prossima');
        const btnRipassaErroriKana = document.getElementById('ripassa-errori-kana-btn'); // Nuovo


        // --- 2. Funzioni Globali (Audio e Utility) ---
        function caricaVoceGiapponese() {
            if (!synth) return;
            const voices = synth.getVoices();
            japaneseVoice = voices.find(voice => voice.lang.startsWith('ja'));
            if (!japaneseVoice && voices.length > 0) { console.warn("Nessuna voce 'ja-JP' trovata."); }
        }
        function parla(testo) {
            if (!synth || !testo) return;
            synth.cancel(); 
            const utterance = new SpeechSynthesisUtterance(testo);
            if (japaneseVoice) { utterance.voice = japaneseVoice; } 
            else { utterance.lang = 'ja-JP'; }
            synth.speak(utterance);
        }
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- 3. Logica Switcher ---
        function showMode(modeToShow) {
            if (modeToShow === 'vocab') {
                vocabWrapper.style.display = 'block';
                kanaWrapper.style.display = 'none';
                btnModeVocab.classList.add('attivo');
                btnModeKana.classList.remove('attivo');
            } else if (modeToShow === 'kana') {
                vocabWrapper.style.display = 'none';
                kanaWrapper.style.display = 'block';
                btnModeVocab.classList.remove('attivo');
                btnModeKana.classList.add('attivo');
            }
        }

        // ===================================
        // --- 4. Logica Quiz VOCABOLI ---
        // ===================================
        
        let mazzoPrincipale = [], mazzoErroriPrioritari = [], erroriSessioneCorrente, mazzoRipassoAttivo = [], mazzoSessioneCorrente = [], indiceSessione = 0;
        let parolaCorrente = null, quizDirection = 'ITA_TO_JPN', modalitaQuiz = 'normale';
        let sessioneCorretti = 0, sessioneSbagliati = 0;
        const KEY_MAZZO_PRINCIPALE = 'mioMazzoPrincipale', KEY_MAZZO_ERRORI = 'mioMazzoErrori', KEY_CSV_URL = 'mioLinkCsvGitHub';

        function creaNuovoSet(numParole = 10) {
            mazzoSessioneCorrente = [];
            indiceSessione = 0;
            let paroleTotaliDisponibili = mazzoErroriPrioritari.length + mazzoPrincipale.length;
            let paroleDaPrendere = Math.min(numParole, paroleTotaliDisponibili);
            if (paroleDaPrendere === 0) return;
            let paroleDaErrori = mazzoErroriPrioritari.splice(0, paroleDaPrendere);
            mazzoSessioneCorrente.push(...paroleDaErrori);
            let numRimanenti = paroleDaPrendere - paroleDaErrori.length;
            if (numRimanenti > 0) {
                let paroleDaMazzo = mazzoPrincipale.splice(0, numRimanenti);
                mazzoSessioneCorrente.push(...paroleDaMazzo);
            }
            mazzoSessioneCorrente = shuffleArray(mazzoSessioneCorrente);
        }
        
        function prossimaParola() {
            promptContainer.style.display = 'flex'; inputRisposta.style.display = 'block'; risultatoControllo.style.display = 'block';
            if (modalitaQuiz === 'ripasso_errori') {
                if (mazzoRipassoAttivo.length > 0) {
                    parolaCorrente = mazzoRipassoAttivo.shift();
                    promptLabel.textContent = `‚ú® RIPASSO (${mazzoRipassoAttivo.length + 1} Rimanenti) ‚ú®`;
                } else {
                    alert("Complimenti! Hai ripassato tutti gli errori di questa sessione.");
                    modalitaQuiz = 'normale';
                }
            }
            if (modalitaQuiz === 'normale') {
                if (indiceSessione < mazzoSessioneCorrente.length) {
                    parolaCorrente = mazzoSessioneCorrente[indiceSessione];
                    indiceSessione++;
                    let etichettaBase = `(Set ${indiceSessione}/${mazzoSessioneCorrente.length}):`;
                    if (Math.random() < 0.5) {
                        quizDirection = 'ITA_TO_JPN';
                        promptLabel.textContent = `TRADUCI ${etichettaBase} (Romaji o Giapponese)`;
                        promptPrincipale.textContent = parolaCorrente.ita;
                        promptSecondario.textContent = parolaCorrente.eng;
                        inputRisposta.placeholder = "Scrivi qui la tua risposta...";
                    } else {
                        quizDirection = 'JPN_TO_ITA';
                        promptLabel.textContent = `TRADUCI ${etichettaBase} (Italiano o Inglese)`;
                        const audioBtnHtml = `<button class="btn-audio" onclick="parla('${parolaCorrente.jpn}')">üîä</button>`;
                        promptPrincipale.innerHTML = `${parolaCorrente.jpn} ${audioBtnHtml}`;
                        promptSecondario.textContent = parolaCorrente.romaji;
                        inputRisposta.placeholder = "Scrivi la traduzione italiana...";
                    }
                } else {
                    modalitaQuiz = 'set_finito';
                    promptLabel.textContent = "BRAVO!";
                    promptPrincipale.innerHTML = "üéâ Set Completato! üéâ";
                    promptSecondario.textContent = `Errori salvati: ${mazzoErroriPrioritari.length}, Mazzo: ${mazzoPrincipale.length}`;
                    inputRisposta.style.display = 'none';
                    risultatoControllo.style.display = 'none';
                    btnControlla.style.display = 'none';
                    btnProssima.textContent = 'Inizia Prossimo Set';
                    btnProssima.style.display = 'block';
                    if (mazzoErroriPrioritari.length === 0 && mazzoPrincipale.length === 0) {
                        promptPrincipale.innerHTML = "üéâ MAZZO COMPLETATO! üéâ";
                        promptSecondario.textContent = "Hai finito tutte le parole. Importane di nuove!";
                        btnProssima.style.display = 'none';
                    }
                    return;
                }
            }
            inputRisposta.value = "";
            risultatoControllo.innerHTML = "";
            inputRisposta.disabled = false;
            btnControlla.style.display = "block";
            btnProssima.style.display = "none";
            aggiornaPunteggio();
        }

        function controllaRisposta() {
            if (!parolaCorrente) return; 
            const rispostaUtente = inputRisposta.value.trim().toLowerCase();
            let isCorrect = false, messaggioErrore = "";
            inputRisposta.disabled = true; 
            btnControlla.style.display = "none";
            btnProssima.style.display = "block"; 
            let audioBtnHtml = `<button class="btn-audio" onclick="parla('${parolaCorrente.jpn}')">üîä</button>`;
            if (quizDirection === 'JPN_TO_ITA') { audioBtnHtml = ""; }
            if (quizDirection === 'ITA_TO_JPN') {
                const rispostaCorrettaRomaji = parolaCorrente.romaji.trim().toLowerCase();
                const rispostaCorrettaJpn = parolaCorrente.jpn.trim();
                isCorrect = (rispostaUtente === rispostaCorrettaRomaji || rispostaUtente === rispostaCorrettaJpn);
                messaggioErrore = `Risposte: <b>${parolaCorrente.romaji}</b> (<b>${parolaCorrente.jpn}</b>${audioBtnHtml})`;
            } else {
                const rispostaCorrettaIta = parolaCorrente.ita.trim().toLowerCase();
                const rispostaCorrettaEng = parolaCorrente.eng.trim().toLowerCase();
                isCorrect = (rispostaUtente === rispostaCorrettaIta || rispostaUtente === rispostaCorrettaEng);
                messaggioErrore = `Risposte: <b>${parolaCorrente.ita}</b> (o <b>${parolaCorrente.eng}</b>)`;
            }
            if (isCorrect) {
                risultatoControllo.innerHTML = `üéâ Corretto! ${audioBtnHtml}`;
                risultatoControllo.className = "corretto";
                sessioneCorretti++;
                if (quizDirection === 'ITA_TO_JPN') parla(parolaCorrente.jpn);
            } else {
                risultatoControllo.innerHTML = `<span class="sbagliato">Sbagliato.</span><br> ${messaggioErrore}`;
                risultatoControllo.className = "sbagliato";
                sessioneSbagliati++;
                erroriSessioneCorrente.add(parolaCorrente);
                if (modalitaQuiz === 'ripasso_errori') { mazzoRipassoAttivo.push(parolaCorrente); }
            }
            aggiornaPunteggio();
        }
        
        function avviaRipassoErrori() {
            if (erroriSessioneCorrente.size === 0) { alert("Nessun errore in questa sessione da ripassare!"); return; }
            modalitaQuiz = 'ripasso_errori';
            mazzoRipassoAttivo = Array.from(erroriSessioneCorrente); 
            erroriSessioneCorrente.clear(); 
            alert(`Modalit√† Ripasso Attivata! Ripasserai ${mazzoRipassoAttivo.length} parole.`);
            prossimaParola();
        }
        
        function aggiornaPunteggio() {
            punteggioDisplay.innerHTML = `
                <span class="punteggio-corr">Corretti: ${sessioneCorretti}</span> | <span class="punteggio-sbag">Sbagliati: ${sessioneSbagliati}</span> <br> 
                <span class="punteggio-prio">Da Rivedere: ${mazzoErroriPrioritari.length}</span> | <span class="punteggio-mazzo">Mazzo: ${mazzoPrincipale.length}</span> |
                <span class="punteggio-sessione">Errori: ${erroriSessioneCorrente.size + mazzoRipassoAttivo.length}</span>
            `;
            const numErroriSessione = erroriSessioneCorrente.size + mazzoRipassoAttivo.length;
            if (numErroriSessione > 0) {
                btnRipassaErrori.disabled = false;
                btnRipassaErrori.textContent = `Ripassa Errori Sessione (${numErroriSessione})`;
            } else {
                btnRipassaErrori.disabled = true;
                btnRipassaErrori.textContent = `Ripassa Errori Sessione (0)`;
            }
        }

        function eliminaParolaCorrente() {
            if (!parolaCorrente) return;
            if (confirm(`Sei sicuro di voler ELIMINARE PERMANENTEMENTE la carta "${parolaCorrente.ita}" dal tuo mazzo principale?`)) {
                let indexInPrincipale = mazzoPrincipale.findIndex(c => c.ita === parolaCorrente.ita);
                if (indexInPrincipale > -1) mazzoPrincipale.splice(indexInPrincipale, 1);
                let indexInErrori = mazzoErroriPrioritari.findIndex(c => c.ita === parolaCorrente.ita);
                if (indexInErrori > -1) mazzoErroriPrioritari.splice(indexInErrori, 1);
                let indexInSessione = mazzoSessioneCorrente.findIndex(c => c.ita === parolaCorrente.ita);
                if (indexInSessione > -1) mazzoSessioneCorrente.splice(indexInSessione, 1);
                salvaMazzoPrincipale();
                alert('Carta eliminata da tutti i mazzi.');
                prossimaParola(); 
            }
        }
        
        function salvaMazzoPrincipale() {
            const mazzoCompleto = [...mazzoPrincipale, ...mazzoErroriPrioritari, ...mazzoSessioneCorrente];
            const mazzoUnico = Array.from(new Map(mazzoCompleto.map(item => [item.ita, item])).values());
            localStorage.setItem(KEY_MAZZO_PRINCIPALE, JSON.stringify(mazzoUnico));
        }

        function salvaErroriSessione() {
            const tuttiErroriDaSalvare = new Set([...erroriSessioneCorrente, ...mazzoRipassoAttivo]);
            localStorage.setItem(KEY_MAZZO_ERRORI, JSON.stringify(Array.from(tuttiErroriDaSalvare)));
            salvaMessaggio.textContent = "Errori salvati! Ricarico la sessione...";
            setTimeout(() => { location.reload(); }, 1500);
        }

        function caricaMazzi() {
            const datiPrincipali = localStorage.getItem(KEY_MAZZO_PRINCIPALE);
            mazzoPrincipale = datiPrincipali ? JSON.parse(datiPrincipali) : [];
            const datiErrori = localStorage.getItem(KEY_MAZZO_ERRORI);
            mazzoErroriPrioritari = datiErrori ? JSON.parse(datiErrori) : [];
            const paroleInErrori = new Set(mazzoErroriPrioritari.map(p => p.ita));
            mazzoPrincipale = mazzoPrincipale.filter(p => !paroleInErrori.has(p.ita));
            mazzoPrincipale = shuffleArray(mazzoPrincipale);
            mazzoErroriPrioritari = shuffleArray(mazzoErroriPrioritari);
            const urlSalvat = localStorage.getItem(KEY_CSV_URL);
            if (urlSalvat) { urlInput.value = urlSalvat; }
            erroriSessioneCorrente = new Set();
            mazzoRipassoAttivo = [];
            sessioneCorretti = 0;
            sessioneSbagliati = 0;
            creaNuovoSet();
        }

        function aggiungiParolaAlMazzo(nuovaParola) {
             const parolaTrimmed = {
                ita: nuovaParola.ita ? nuovaParola.ita.trim() : "",
                eng: nuovaParola.eng ? nuovaParola.eng.trim() : "",
                jpn: nuovaParola.jpn ? nuovaParola.jpn.trim() : "",
                romaji: nuovaParola.romaji ? nuovaParola.romaji.trim() : ""
            };
            if (!parolaTrimmed.ita || !parolaTrimmed.eng || !parolaTrimmed.jpn || !parolaTrimmed.romaji) {
                return { success: false, motivo: "Campi mancanti" };
            }
            const esisteGia = [...mazzoPrincipale, ...mazzoErroriPrioritari, ...mazzoSessioneCorrente, ...mazzoRipassoAttivo].some(carta => carta.ita.toLowerCase() === parolaTrimmed.ita.toLowerCase());
            if (esisteGia) {
                return { success: false, motivo: "Duplicato" };
            }
            mazzoPrincipale.push(parolaTrimmed);
            return { success: true };
        }

        function gestisciSalvataggioForm(event) {
            event.preventDefault();
            const nuovaParola = { ita: inputIta.value, eng: inputEng.value, jpn: inputJpn.value, romaji: inputRomaji.value };
            const risultato = aggiungiParolaAlMazzo(nuovaParola);
            if (risultato.success) {
                salvaMazzoPrincipale(); 
                form.reset();
                messaggioSalvataggio.textContent = "Parola salvata!";
                aggiornaPunteggio();
                setTimeout(() => { messaggioSalvataggio.textContent = ""; }, 2500);
            } else {
                alert(`Errore: ${risultato.motivo}. La parola non √® stata salvata.`);
            }
        }
        
        function processaTestoCSV(testo) {
            const righe = testo.split('\n');
            let paroleAggiunte = 0, paroleSaltate = []; 
            importDettagli.style.display = "none"; importErroriLista.innerHTML = "";
            const primaRiga = righe[0].toLowerCase();
            const inizio = (primaRiga.includes("italiano") || primaRiga.includes("inglese")) ? 1 : 0;
            for (let i = inizio; i < righe.length; i++) {
                const riga = righe[i].trim();
                if (riga === "") continue;
                const colonne = riga.split(',');
                if (colonne.length < 4) {
                    paroleSaltate.push({ parola: riga.split(',')[0] || "Riga illeggibile", motivo: "Malformata" });
                    continue;
                }
                const parola = { ita: colonne[0], eng: colonne[1], jpn: colonne[2], romaji: colonne[3] };
                const risultato = aggiungiParolaAlMazzo(parola);
                if (risultato.success) { paroleAggiunte++; } 
                else { paroleSaltate.push({ parola: parola.ita, motivo: risultato.motivo }); }
            }
            salvaMazzoPrincipale();
            if (paroleSaltate.length > 0) {
                importDettagli.style.display = "block";
                paroleSaltate.forEach(errore => {
                    const li = document.createElement('li');
                    li.textContent = `"${errore.parola}": ${errore.motivo}`;
                    importErroriLista.appendChild(li);
                });
            }
            return { aggiunte: paroleAggiunte, saltate: paroleSaltate.length };
        }
        
        function gestisciImportaCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            importMessaggio.textContent = "Caricamento in corso...";
            const reader = new FileReader();
            reader.onload = function(e) {
                const testo = e.target.result;
                const { aggiunte, saltate } = processaTestoCSV(testo);
                importMessaggio.textContent = `Importazione completata! Aggiunte: ${aggiunte}, Saltate: ${saltate}.`;
                importMessaggio.className = "corretto";
                fileInput.value = ""; 
                if (aggiunte > 0) {
                    setTimeout(() => {
                        alert(`Aggiunte ${aggiunte} nuove parole. Ricarica la pagina per iniziare!`);
                        location.reload();
                    }, 1000);
                }
            };
            reader.onerror = function() {
                importMessaggio.textContent = "Errore nella lettura del file.";
                importMessaggio.className = "sbagliato";
            };
            reader.readAsText(file, "UTF-8");
        }
        
        async function gestisciAggiornaDaUrl() {
            const url = urlInput.value.trim();
            if (!url) { alert("Per favore, inserisci un link URL al file .csv"); return; }
            localStorage.setItem(KEY_CSV_URL, url);
            updateMessaggio.textContent = "Aggiornamento in corso...";
            updateMessaggio.className = "";
            try {
                const response = await fetch(url);
                if (!response.ok) { throw new Error(`Errore di rete: ${response.statusText}`); }
                const testo = await response.text();
                const { aggiunte, saltate } = processaTestoCSV(testo);
                updateMessaggio.textContent = `Aggiornato! Aggiunte: ${aggiunte}, Saltate: ${saltate}.`;
                updateMessaggio.className = "corretto";
                if (aggiunte > 0) {
                    setTimeout(() => {
                        alert(`Aggiunte ${aggiunte} nuove parole. Ricarica la pagina per iniziare!`);
                        location.reload();
                    }, 1000);
                }
            } catch (error) {
                console.error("Errore aggiornamento da URL:", error);
                updateMessaggio.textContent = "Errore! Controlla il link o la console (Errore CORS?).";
                updateMessaggio.className = "sbagliato";
                alert("Aggiornamento fallito. Assicurati che il link sia un link 'Raw' da GitHub e che il repository sia pubblico.");
            }
        }
        
        // ===================================
        // --- 5. Logica Quiz KANA (NUOVA) ---
        // ===================================
        
        const mazzoKanaOriginale = [
            { kana: '„ÅÇ', romaji: 'a' }, { kana: '„ÅÑ', romaji: 'i' }, { kana: '„ÅÜ', romaji: 'u' }, { kana: '„Åà', romaji: 'e' }, { kana: '„Åä', romaji: 'o' },
            { kana: '„Åã', romaji: 'ka' }, { kana: '„Åç', romaji: 'ki' }, { kana: '„Åè', romaji: 'ku' }, { kana: '„Åë', romaji: 'ke' }, { kana: '„Åì', romaji: 'ko' },
            { kana: '„Åï', romaji: 'sa' }, { kana: '„Åó', romaji: 'shi' }, { kana: '„Åô', romaji: 'su' }, { kana: '„Åõ', romaji: 'se' }, { kana: '„Åù', romaji: 'so' },
            { kana: '„Åü', romaji: 'ta' }, { kana: '„Å°', romaji: 'chi' }, { kana: '„Å§', romaji: 'tsu' }, { kana: '„Å¶', romaji: 'te' }, { kana: '„Å®', romaji: 'to' },
            { kana: '„Å™', romaji: 'na' }, { kana: '„Å´', romaji: 'ni' }, { kana: '„Å¨', romaji: 'nu' }, { kana: '„Å≠', romaji: 'ne' }, { kana: '„ÅÆ', romaji: 'no' },
            { kana: '„ÅØ', romaji: 'ha' }, { kana: '„Å≤', romaji: 'hi' }, { kana: '„Åµ', romaji: 'fu' }, { kana: '„Å∏', romaji: 'he' }, { kana: '„Åª', romaji: 'ho' },
            { kana: '„Åæ', romaji: 'ma' }, { kana: '„Åø', romaji: 'mi' }, { kana: '„ÇÄ', romaji: 'mu' }, { kana: '„ÇÅ', romaji: 'me' }, { kana: '„ÇÇ', romaji: 'mo' },
            { kana: '„ÇÑ', romaji: 'ya' }, { kana: '„ÇÜ', romaji: 'yu' }, { kana: '„Çà', romaji: 'yo' },
            { kana: '„Çâ', romaji: 'ra' }, { kana: '„Çä', romaji: 'ri' }, { kana: '„Çã', romaji: 'ru' }, { kana: '„Çå', romaji: 're' }, { kana: '„Çç', romaji: 'ro' },
            { kana: '„Çè', romaji: 'wa' }, { kana: '„Çí', romaji: 'o' }, { kana: '„Çì', romaji: 'n' },
            { kana: '„Åå', romaji: 'ga' }, { kana: '„Åé', romaji: 'gi' }, { kana: '„Åê', romaji: 'gu' }, { kana: '„Åí', romaji: 'ge' }, { kana: '„Åî', romaji: 'go' },
            { kana: '„Åñ', romaji: 'za' }, { kana: '„Åò', romaji: 'ji' }, { kana: '„Åö', romaji: 'zu' }, { kana: '„Åú', romaji: 'ze' }, { kana: '„Åû', romaji: 'zo' },
            { kana: '„Å†', romaji: 'da' }, { kana: '„Å¢', romaji: 'ji' }, { kana: '„Å•', romaji: 'zu' }, { kana: '„Åß', romaji: 'de' }, { kana: '„Å©', romaji: 'do' },
            { kana: '„Å∞', romaji: 'ba' }, { kana: '„Å≥', romaji: 'bi' }, { kana: '„Å∂', romaji: 'bu' }, { kana: '„Åπ', romaji: 'be' }, { kana: '„Åº', romaji: 'bo' },
            { kana: '„Å±', romaji: 'pa' }, { kana: '„Å¥', romaji: 'pi' }, { kana: '„Å∑', romaji: 'pu' }, { kana: '„Å∫', romaji: 'pe' }, { kana: '„ÅΩ', romaji: 'po' },
            { kana: '„Ç¢', romaji: 'a' }, { kana: '„Ç§', romaji: 'i' }, { kana: '„Ç¶', romaji: 'u' }, { kana: '„Ç®', romaji: 'e' }, { kana: '„Ç™', romaji: 'o' },
            { kana: '„Ç´', romaji: 'ka' }, { kana: '„Ç≠', romaji: 'ki' }, { kana: '„ÇØ', romaji: 'ku' }, { kana: '„Ç±', romaji: 'ke' }, { kana: '„Ç≥', romaji: 'ko' },
            { kana: '„Çµ', romaji: 'sa' }, { kana: '„Ç∑', romaji: 'shi' }, { kana: '„Çπ', romaji: 'su' }, { kana: '„Çª', romaji: 'se' }, { kana: '„ÇΩ', romaji: 'so' },
            { kana: '„Çø', romaji: 'ta' }, { kana: '„ÉÅ', romaji: 'chi' }, { kana: '„ÉÑ', romaji: 'tsu' }, { kana: '„ÉÜ', romaji: 'te' }, { kana: '„Éà', romaji: 'to' },
            { kana: '„Éä', romaji: 'na' }, { kana: '„Éã', romaji: 'ni' }, { kana: '„Éå', romaji: 'nu' }, { kana: '„Éç', romaji: 'ne' }, { kana: '„Éé', romaji: 'no' },
            { kana: '„Éè', romaji: 'ha' }, { kana: '„Éí', romaji: 'hi' }, { kana: '„Éï', romaji: 'fu' }, { kana: '„Éò', romaji: 'he' }, { kana: '„Éõ', romaji: 'ho' },
            { kana: '„Éû', romaji: 'ma' }, { kana: '„Éü', romaji: 'mi' }, { kana: '„É†', romaji: 'mu' }, { kana: '„É°', romaji: 'me' }, { kana: '„É¢', romaji: 'mo' },
            { kana: '„É§', romaji: 'ya' }, { kana: '„É¶', romaji: 'yu' }, { kana: '„É®', romaji: 'yo' },
            { kana: '„É©', romaji: 'ra' }, { kana: '„É™', romaji: 'ri' }, { kana: '„É´', romaji: 'ru' }, { kana: '„É¨', romaji: 're' }, { kana: '„É≠', romaji: 'ro' },
            { kana: '„ÉØ', romaji: 'wa' }, { kana: '„É≤', romaji: 'o' }, { kana: '„É≥', romaji: 'n' },
            { kana: '„Ç¨', romaji: 'ga' }, { kana: '„ÇÆ', romaji: 'gi' }, { kana: '„Ç∞', romaji: 'gu' }, { kana: '„Ç≤', romaji: 'ge' }, { kana: '„Ç¥', romaji: 'go' },
            { kana: '„Ç∂', romaji: 'za' }, { kana: '„Ç∏', romaji: 'ji' }, { kana: '„Ç∫', romaji: 'zu' }, { kana: '„Çº', romaji: 'ze' }, { kana: '„Çæ', romaji: 'zo' },
            { kana: '„ÉÄ', romaji: 'da' }, { kana: '„ÉÇ', romaji: 'ji' }, { kana: '„ÉÖ', romaji: 'zu' }, { kana: '„Éá', romaji: 'de' }, { kana: '„Éâ', romaji: 'do' },
            { kana: '„Éê', romaji: 'ba' }, { kana: '„Éì', romaji: 'bi' }, { kana: '„Éñ', romaji: 'bu' }, { kana: '„Éô', romaji: 'be' }, { kana: '„Éú', romaji: 'bo' },
            { kana: '„Éë', romaji: 'pa' }, { kana: '„Éî', romaji: 'pi' }, { kana: '„Éó', romaji: 'pu' }, { kana: '„Éö', romaji: 'pe' }, { kana: '„Éù', romaji: 'po' }
        ];
        
        let mazzoKanaCompleto = [];
        let mazzoSetKanaCorrente = [];
        let erroriSetKana = new Set();
        let indiceSetKana = 0;
        let kanaCorrente = null;
        let modalitaQuizKana = 'normale'; // 'normale', 'ripasso_errori', 'set_finito'

        function aggiornaPunteggioKana() {
            let numErrori = erroriSetKana.size;
            if (modalitaQuizKana === 'ripasso_errori') {
                numErrori = mazzoRipassoAttivo.length;
            }
            
            punteggioKanaContainer.innerHTML = `
                <span class="punteggio-mazzo">Set: ${indiceSetKana}/${mazzoSetKanaCorrente.length}</span> |
                <span class="punteggio-sessione">Errori Set: ${numErrori}</span>
            `;
            if (numErrori > 0) {
                btnRipassaErroriKana.disabled = false;
                btnRipassaErroriKana.textContent = `Ripassa Errori Set (${numErrori})`;
            } else {
                btnRipassaErroriKana.disabled = true;
                btnRipassaErroriKana.textContent = `Ripassa Errori Set (0)`;
            }
        }
        
        function creaNuovoSetKana(num = 10) {
            mazzoSetKanaCorrente = [];
            indiceSetKana = 0;
            erroriSetKana.clear();
            
            if (mazzoKanaCompleto.length < num) {
                // Ricarica e mescola se il mazzo √® quasi vuoto
                mazzoKanaCompleto = shuffleArray([...mazzoKanaOriginale]);
            }
            
            // Prendi 'num' parole
            mazzoSetKanaCorrente = mazzoKanaCompleto.splice(0, num);
            modalitaQuizKana = 'normale';
        }

        function prossimoKana() {
            // UI di base
            promptKana.style.display = 'block';
            inputKanaRisposta.style.display = 'block';
            
            if (modalitaQuizKana === 'ripasso_errori') {
                if (mazzoRipassoAttivo.length > 0) {
                    kanaCorrente = mazzoRipassoAttivo.shift();
                    promptKana.textContent = kanaCorrente.kana;
                    punteggioKanaContainer.textContent = `‚ú® RIPASSO (${mazzoRipassoAttivo.length} Rimanenti) ‚ú®`;
                } else {
                    alert("Complimenti! Hai ripassato tutti gli errori di questo set.");
                    modalitaQuizKana = 'normale';
                    // Passa a controllare se il set √® finito
                }
            }
            
            if (modalitaQuizKana === 'normale') {
                if (indiceSetKana < mazzoSetKanaCorrente.length) {
                    kanaCorrente = mazzoSetKanaCorrente[indiceSetKana];
                    indiceSetKana++;
                    promptKana.textContent = kanaCorrente.kana;
                } else {
                    modalitaQuizKana = 'set_finito';
                    promptKana.textContent = 'üéâ';
                    risultatoKanaControllo.innerHTML = `<strong>Set Completato!</strong><br>Premi "Prossimo Set" per continuare.`;
                    inputKanaRisposta.style.display = 'none';
                    btnKanaControlla.style.display = 'none';
                    btnKanaProssima.textContent = "Prossimo Set";
                    btnKanaProssima.style.display = 'block';
                    aggiornaPunteggioKana();
                    return;
                }
            }
            
            // Resetta UI
            inputKanaRisposta.value = "";
            risultatoKanaControllo.innerHTML = "";
            inputKanaRisposta.disabled = false;
            btnKanaControlla.style.display = "block";
            btnKanaProssima.style.display = "none";
            aggiornaPunteggioKana();
        }

        function controllaRispostaKana() {
            if (!kanaCorrente) return;
            const rispostaUtente = inputKanaRisposta.value.trim().toLowerCase();
            const rispostaCorretta = kanaCorrente.romaji.toLowerCase();
            inputKanaRisposta.disabled = true;
            btnKanaControlla.style.display = "none";
            btnKanaProssima.style.display = "block";
            btnKanaProssima.textContent = "Prossima"; // Assicurati sia "Prossima"
            
            const audioBtnHtml = `<button class="btn-audio" onclick="parla('${kanaCorrente.kana}')">üîä</button>`;
            
            if (rispostaUtente === rispostaCorretta) {
                risultatoKanaControllo.innerHTML = `üéâ Corretto! ${audioBtnHtml}`;
                risultatoKanaControllo.className = "corretto";
                parla(kanaCorrente.kana);
            } else {
                risultatoKanaControllo.innerHTML = `
                    <span class="sbagliato">Sbagliato.</span><br>
                    Era: <strong>${kanaCorrente.romaji}</strong> ${audioBtnHtml}
                `;
                risultatoKanaControllo.className = "sbagliato";
                erroriSetKana.add(kanaCorrente); // Aggiungi all'elenco errori
                
                if (modalitaQuizKana === 'ripasso_errori') {
                    mazzoRipassoAttivo.push(kanaCorrente); // Rimetti in fondo
                }
            }
            aggiornaPunteggioKana();
        }
        
        function avviaRipassoErroriKana() {
            if (erroriSetKana.size === 0) {
                alert("Nessun errore in questo set da ripassare!");
                return;
            }
            modalitaQuizKana = 'ripasso_errori';
            mazzoRipassoAttivo = Array.from(erroriSetKana);
            erroriSetKana.clear();
            alert(`Modalit√† Ripasso Attivata! Ripasserai ${mazzoRipassoAttivo.length} caratteri.`);
            prossimoKana();
        }

        // --- 7. Event Listeners ---
        // Switcher
        btnModeVocab.addEventListener('click', () => showMode('vocab'));
        btnModeKana.addEventListener('click', () => showMode('kana'));
        
        // Vocab
        btnControlla.addEventListener('click', controllaRisposta);
        btnProssima.addEventListener('click', () => {
            if (modalitaQuiz === 'set_finito') {
                modalitaQuiz = 'normale';
                creaNuovoSet(); 
                btnProssima.textContent = 'Prossima';
                prossimaParola();
            } else {
                prossimaParola();
            }
        });
        btnElimina.addEventListener('click', eliminaParolaCorrente);
        btnSalvaSessione.addEventListener('click', salvaErroriSessione);
        btnRipassaErrori.addEventListener('click', avviaRipassoErrori);
        form.addEventListener('submit', gestisciSalvataggioForm);
        fileInput.addEventListener('change', gestisciImportaCSV);
        updateUrlBtn.addEventListener('click', gestisciAggiornaDaUrl); 
        inputRisposta.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && btnControlla.style.display === "block") {
                event.preventDefault(); controllaRisposta();
            }
        });

        // Kana
        btnKanaControlla.addEventListener('click', controllaRispostaKana);
        btnKanaProssima.addEventListener('click', () => {
            if (modalitaQuizKana === 'set_finito') {
                creaNuovoSetKana(); // Prepara il nuovo set
                modalitaQuizKana = 'normale'; // Resetta la modalit√†
            }
            prossimoKana(); // Chiama sempre prossima
        });
        btnRipassaErroriKana.addEventListener('click', avviaRipassoErroriKana);
        inputKanaRisposta.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && btnKanaControlla.style.display === "block") {
                event.preventDefault(); controllaRispostaKana();
S            }
        });
        
        // --- 8. Avvio ---
        // Avvio Vocaboli
        caricaMazzi();
        aggiornaPunteggio();
        if (mazzoSessioneCorrente.length > 0 || mazzoErroriPrioritari.length > 0 || mazzoPrincipale.length > 0) {
            prossimaParola();
        } else {
            quizContainer.style.display = 'none';
            punteggioDisplay.style.display = 'none';
            nessunaCartaMsg.style.display = 'block';
        }
        
        // Avvio Kana
        mazzoKanaCompleto = shuffleArray([...mazzoKanaOriginale]);
        creaNuovoSetKana();
        prossimoKana();
        
        // Audio
        caricaVoceGiapponese();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = caricaVoceGiapponese;
        }
        
        // Mostra modalit√† iniziale
        showMode('vocab');

    </script>
</body>
</html>